<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.axiasoft.vote_back.admin.dao">
    <select id="selectAdminListCount" parameterType="hashmap" resultType="int">
        SELECT
        count(*) count
        FROM
        axia.admin A
        left join axia.admin_detail AD
        on AD.ad_idx = A.ad_idx
        WHERE
        1=1
        <if test="searchText !=null and searchText !='' ">
            AND
            <choose>
                <when test="searchType == 0">
                    A.ad_id LIKE '%${searchText}%'
                </when>
                <when test="searchType == 1">
                    AD.ad_name LIKE '%${searchText}%'
                </when>
                <when test="searchType == 2">
                    AD.ad_phone LIKE '%${searchText}%'
                </when>
            </choose>
        </if>

        ORDER BY
        A.ad_idx desc
    </select>

    <select id="selectAdminList" parameterType="hashmap" resultType="hashmap">
        SELECT
        A.ad_idx,
        A.ad_id,
        A.ad_pw,
        A.ad_otp_code,
        A.ad_level,
        AD.ad_name,
        AD.ad_phone,
        DATE_FORMAT(A.reg_date, '%Y-%m-%d') AS "reg_date"
        FROM
        axia.admin A
        left join axia.admin_detail AD
        on AD.ad_idx = A.ad_idx
        WHERE
        1=1
        <if test="searchText !=null and searchText !='' ">
            AND
            <choose>
                <when test="searchType == 0">
                    A.ad_id LIKE '%${searchText}%'
                </when>
                <when test="searchType == 1">
                    AD.ad_name LIKE '%${searchText}%'
                </when>
                <when test="searchType == 2">
                    AD.ad_phone LIKE '%${searchText}%'
                </when>
            </choose>
        </if>
        ORDER BY
        A.ad_idx desc
        <if test="startNum != null and !startNum.equals('') and lastNum != null and !lastNum.equals('')">
            LIMIT #{startNum}, #{lastNum}
        </if>
    </select>

    <select id="selectAdmin" parameterType="int" resultType="hashmap">
        SELECT
            A.ad_idx,
            A.ad_id,
            A.ad_pw,
            A.ad_otp_code,
            A.ad_level,
            AD.ad_name,
            AD.ad_phone,
            DATE_FORMAT(A.reg_date, '%Y-%m-%d') AS "reg_date"
        FROM
            axia.admin A
        LEFT JOIN
            axia.admin_detail AD
        ON
            AD.ad_idx = A.ad_idx
        WHERE
            1=1
        AND
            A.ad_idx = ${ad_idx}
    </select>



    <select id="selectLogin" parameterType="hashmap" resultType="hashmap">
        SELECT *
        FROM axia.admin
        WHERE ad_id = #{ad_id}
        AND ad_pw = #{ad_password}
    </select>

    <select id="selectLatestRound" resultType="int">
        SELECT round
        FROM axia.vote_round
        ORDER BY round DESC
        LIMIT 1
    </select>

    <select id="selectStartRound" resultType="int">
        SELECT round
        FROM axia.vote_round
        WHERE start_date > now()
        ORDER BY round
        LIMIT 1
    </select>

    <select id="selectCurrentRound" resultType="hashmap">
        SELECT round
        FROM axia.vote_round
        WHERE now() between start_date and end_date
    </select>

    <select id="selectUnfinishedRound" resultType="hashmap">
        SELECT round
        FROM axia.vote_round
        WHERE end_date >= now()
    </select>

    <select id="selectVoteResult" parameterType="hashmap" resultType="hashmap">
        SELECT vr.vote_round                                            as round,
               cl.coin_name                                             as coin_name,
               COUNT(vr.vote_target) OVER (PARTITION BY vr.vote_target) as count,
               rd.start_date                                            as start_date,
               rd.end_date                                              as end_date
        FROM axia.vote_result vr
                 INNER JOIN axia.coin_list cl
                            ON vr.vote_target = cl.coin_idx
                 INNER JOIN axia.vote_round rd
                            ON vr.vote_round = rd.round
        WHERE vr.vote_round = #{round}
        ORDER BY vr.vote_round, vr.vote_target;
    </select>

    <select id="selectRoundList" resultType="com.axiasoft.vote_back.admin.domain.RoundVO">
        SELECT vr.round,
               vr.round_content as content,
               vr.round_title as title,
               date_format(vr.start_date,'%Y-%m-%d') as startDate,
               date_format(vr.end_date,'%Y-%m-%d') as endDate
        FROM axia.vote_round vr
        order by vr.round
    </select>

    <select id="selectRoundInfo" parameterType="int" resultType="com.axiasoft.vote_back.admin.domain.RoundVO">
        SELECT vr.round,
               vr.round_content as content,
               vr.round_title as title,
               date_format(vr.start_date,'%Y-%m-%d') as startDate,
               date_format(vr.end_date,'%Y-%m-%d') as endDate
        FROM axia.vote_round vr
        WHERE round = #{num}
        LIMIT 1
    </select>

    <select id="selectVoteList" parameterType="hashmap" resultType="hashmap">
        SELECT vr.round_content, vr.round_title, vr.start_date, vr.end_date ,cl.coin_name, cl.coin_idx, cl.coin_info, cl.coin_symbol, cp.order_idx, cp.picture
        FROM axia.coin_list cl
                 JOIN axia.vote_round vr
                      ON cl.vote_round = vr.round
                 LEFT JOIN axia.coin_pic cp
                           ON cl.coin_idx = cp.coin_idx
        WHERE cl.vote_round = #{round}
        order by coin_idx, order_idx;
    </select>

    <select id="selectLatestVoteResult" resultType="hashmap">
        SELECT vote_round as round,
               vote_target as coin_idx,
               COUNT(*) OVER (PARTITION BY vote_target) as count
        FROM axia.vote_result
        WHERE vote_round = (SELECT MAX(vote_round) FROM axia.vote_result)
        ORDER BY vote_target
    </select>

    <insert id="insertCoin" parameterType="hashmap" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO axia.coin_list
            (coin_name,
             coin_info,
             coin_symbol,
             vote_round,
             ad_idx)
            VALUES (#{coin_name},
                    #{coin_info},
                    #{coin_symbol},
                    #{round},
                    1)
    </insert>
    <insert id="insertCoinPicture" parameterType="hashmap">
        INSERT INTO axia.coin_pic
        VALUES (#{coin_idx}, #{picture}, #{order_idx})
    </insert>
    <insert id="insertVote" parameterType="com.axiasoft.vote_back.admin.domain.RoundVO">
        INSERT INTO axia.vote_round
        (round, round_title, round_content, ad_idx, reg_date, start_date, end_date)
        VALUES (#{round}, #{title}, #{content}, 1, now(), #{startDate}, #{endDate})
        ON DUPLICATE KEY UPDATE
            round_title = #{title},
            round_content = #{content},
            ad_idx = 1,
            reg_date = now(),
            start_date = #{startDate},
            end_date = #{endDate}
    </insert>
    <insert id="insertAdmin" parameterType="com.axiasoft.vote_back.admin.dto.AdminDTO" useGeneratedKeys="true"  keyProperty="ad_idx">
        INSERT INTO
            axia.admin(ad_id,ad_pw,ad_level,reg_date)
        VALUES
            (
                ${ad_id},
                ${ad_pw},
                ${ad_level},
                NOW()
            )
        ON DUPLICATE KEY UPDATE
            ad_id = ${ad_id},
            ad_pw = ${ad_pw}
    </insert>

    <insert id="insertAdminDetail" parameterType="com.axiasoft.vote_back.admin.dto.AdminDetailDTO">
        INSERT INTO
            axia.admin_detail(ad_idx,ad_name,ad_phone)
        VALUES
            (
                ${ad_idx},
                ${ad_name},
                ${ad_phone}
            )
    </insert>
</mapper>